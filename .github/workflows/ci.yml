name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-cleanup: true

      - name: Common metadata compilation
        run: ./gradlew :shared:compileCommonMainKotlinMetadata

      - name: Run shared module tests
        run: >-
          ./gradlew --continue
          :shared:core:testAndroidHostTest
          :shared:networking:testAndroidHostTest
          :shared:tempo:testAndroidHostTest
          :shared:engine:testAndroidHostTest
          :shared:simulation:testAndroidHostTest
          :shared:vision:testAndroidHostTest
          :shared:agent:testAndroidHostTest

      - name: Run Lint
        run: ./gradlew :android:app:lintDebug

      - name: Build Android APK
        run: ./gradlew :android:app:assembleDebug

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Generate Summary
        if: always()
        run: |
          echo "### Build & Test Summary ðŸš€" >> $GITHUB_STEP_SUMMARY

          total_tests=0
          total_failures=0
          total_errors=0

          echo "| Module | Tests | Failures | Errors | Result |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :---: | :---: | :---: |" >> $GITHUB_STEP_SUMMARY

          modules=("core" "networking" "tempo" "engine" "simulation" "vision" "agent")
          for mod in "${modules[@]}"; do
            report_dir="shared/$mod/build/test-results/testAndroidHostTest"
            if [ -d "$report_dir" ]; then
              m_tests=$(grep -rh "testsuite" "$report_dir" | grep -oE 'tests="[0-9]+"' | cut -d'"' -f2 | awk '{s+=$1} END {print s}' || echo 0)
              m_failures=$(grep -rh "testsuite" "$report_dir" | grep -oE 'failures="[0-9]+"' | cut -d'"' -f2 | awk '{s+=$1} END {print s}' || echo 0)
              m_errors=$(grep -rh "testsuite" "$report_dir" | grep -oE 'errors="[0-9]+"' | cut -d'"' -f2 | awk '{s+=$1} END {print s}' || echo 0)

              m_tests=${m_tests:-0}
              m_failures=${m_failures:-0}
              m_errors=${m_errors:-0}

              status="âœ…"
              if [ "$m_tests" -eq 0 ]; then
                status="â“"
              elif [ "$m_failures" -gt 0 ] || [ "$m_errors" -gt 0 ]; then
                status="âŒ"
              fi

              echo "| $mod | $m_tests | $m_failures | $m_errors | $status |" >> $GITHUB_STEP_SUMMARY

              total_tests=$((total_tests + m_tests))
              total_failures=$((total_failures + m_failures))
              total_errors=$((total_errors + m_errors))
            else
              echo "| $mod | - | - | - | â“ |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests:** $total_tests" >> $GITHUB_STEP_SUMMARY
          echo "**Total Failures:** $((total_failures + total_errors))" >> $GITHUB_STEP_SUMMARY

          if [ "$total_tests" -gt 0 ] && [ "$total_failures" -eq 0 ] && [ "$total_errors" -eq 0 ]; then
            echo "### All tests passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          elif [ "$total_tests" -eq 0 ]; then
             echo "### No tests found or tests failed! âŒ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Some tests failed. âŒ" >> $GITHUB_STEP_SUMMARY
          fi
