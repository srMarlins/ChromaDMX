name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string (e.g. 1.2.3). Defaults to 0.0.0-SNAPSHOT if empty.'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  release:
    name: Build & Release Android
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Resolve version
        env:
          REF: ${{ github.ref }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          if [[ "$REF" == refs/tags/v* ]]; then
            VERSION="${REF#refs/tags/v}"
          elif [[ -n "$INPUT_VERSION" ]]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="0.0.0-SNAPSHOT"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Resolved version: $VERSION"

      - name: Generate versionCode
        run: |
          VERSION_CODE=${{ github.run_number }}
          echo "VERSION_CODE=$VERSION_CODE" >> "$GITHUB_ENV"
          echo "Generated versionCode: $VERSION_CODE"

      - name: Decode keystore
        run: |
          if [[ -n "$RELEASE_KEYSTORE_BASE64" ]]; then
            echo "$RELEASE_KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/release.jks"
            echo "Keystore decoded to $RUNNER_TEMP/release.jks"
          else
            echo "No keystore secret provided â€” skipping decode"
          fi
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}

      - name: Build release APK and AAB
        run: >-
          ./gradlew
          :android:app:assembleRelease
          :android:app:bundleRelease
          -PversionName=${{ env.VERSION }}
          -PversionCode=${{ env.VERSION_CODE }}
        env:
          RELEASE_STORE_FILE: ${{ runner.temp }}/release.jks
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/*.apk

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/*.aab

      - name: Create GitHub Release
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            android/app/build/outputs/apk/release/*.apk
            android/app/build/outputs/bundle/release/*.aab

      - name: Upload to Play Store
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: r0adkll/upload-google-play@v1
        continue-on-error: true
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.chromadmx.android
          releaseFiles: android/app/build/outputs/bundle/release/*.aab
          track: internal
